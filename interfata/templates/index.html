

    function introduCuvant(cuvant = cuvCurent){
      cuvCurent = cuvant
      let xhr = new XMLHttpRequest()
      xhr.open("POST", "/get_feedback")
      xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}')

      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          let feedback = JSON.parse(xhr.responseText)
          addIstoric(feedback["pattern"])
          if(feedback["corecte"].length == 5){
            if((indexCuvant+1) === listaCuvinte.length && feedback["i"] === 0){
              opreste()
              download(textDovada)
              return
            }
            textDovada += cuvCurent + " " + parteTextDovada.trim() + "\n"
            clearIstoric()
            cuvCurent = ""
            indexCuvant = feedback["i"]
            renderCuvant()
            if(inceput){
              introduCuvant("TAREI")
            }
            return
          }
          
          cuvCurent = ""
          renderCuvant()
          if(inceput){
            let ghicit
            if(incercari.length < 2){
              ghicit = ghici(0, feedback["pattern"])
            }else{
              ghicit = ghici(1, feedback["pattern"])
            }
            introduCuvant(ghicit)
          }
        }}

      let data = {
        "cuv": cuvCurent,
      }

      xhr.send(JSON.stringify(data))
    }

    function clearIstoric(){
      document.getElementById("istoric-joc").innerHTML = ""
      parteTextDovada = ""
      listaRestransa = listaCuvinte
      sumaIncerc += incercari.length
      incercari = []
    }


    function addIstoric(pattern){
      parteTextDovada += cuvCurent + " "

      let spatiu = document.getElementById("istoric-joc")

      let rand = document.createElement("div")
      rand.className = "rand-litere"
      
      for (let i = 0; i < 5; i++) {
          let casuta = document.createElement("div")
          if(pattern.charAt(i) === '2'){
            casuta.className = "casuta casuta-corect"
          }else if(pattern.charAt(i) === '1'){
            casuta.className = "casuta casuta-partial"
          }else{
            casuta.className = "casuta casuta-gresit"
          }
          casuta.textContent = cuvCurent.charAt(i)
          rand.appendChild(casuta)
      }
      spatiu.appendChild(rand)
      

      incercari.push(cuvCurent)
      let cuv_de_la_pattern = ls_rasp[cuvCurent][pattern]
      listaRestransa = listaRestransa.filter(value => cuv_de_la_pattern.includes(value))
    }

    function renderCuvant(){
      let rand = document.getElementsByClassName("rand-litere")[0]
      
      for (let i = 0; i < 5; i++) {
        let casuta = rand.children[i]
        if(i >= cuvCurent.length){
          casuta.textContent = ""
        }else{
          casuta.textContent = cuvCurent.charAt(i)
        }
      }

      document.getElementById("status").innerText = (indexCuvant+1)+" / "+listaCuvinte.length
      document.getElementById("incercari").innerText = "Incercari: "+ incercari.length+" - "+(sumaIncerc/(indexCuvant+1))
    }

    function incepe(){
      if(!inceput){
        inceput = true
        document.getElementById("start").setAttribute('disabled', '')
        document.getElementById("rest").removeAttribute('disabled', '')
        introduCuvant("TAREI")
      }
    }

    function opreste(){
      if(inceput){
        inceput = false

        document.getElementById("rest").setAttribute('disabled', '')
        document.getElementById("start").removeAttribute('disabled', '')
      }
    }

    function reset(){
      if(inceput){
          sumaIncerc = 0
          let xhr = new XMLHttpRequest()
          xhr.open("POST", "/reset")
          xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}')

          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
              inceput = false
              location.reload()
            }}

          xhr.send()
      }
    }

    download = function (text) {
      let textFile = null;
      var data = new Blob([text], {type: 'text/plain'});

      if (textFile !== null) {
        window.URL.revokeObjectURL(textFile);
      }

      textFile = window.URL.createObjectURL(data);
      var a = document.createElement("a");
      document.body.appendChild(a);
      a.style = "display: none";
      a.href = textFile;
      a.download = "rezultate.txt";
      a.click();
      window.URL.revokeObjectURL(textFile);
    };

    document.getElementById("status").innerText = "Se incarca..."

    let copieCuvList = [...listaCuvinte]

    let ls_rasps = []
    const parti = 4

    let suma = 0

    var timpInceput = new Date().getTime()

    for (let i = parti; i > 0; i--) {
        let bucata = copieCuvList.splice(0, Math.ceil(copieCuvList.length / i))
        let cuvLoad = new Worker("/static/raspunsuri_loader.js")
        cuvLoad.addEventListener("message", function handleLista(e) {
          if(e.data[0] === 0){
            suma += e.data[1]
            document.getElementById("status").innerText = "Se incarca: "+Math.floor((suma/listaCuvinte.length)*100) + " %"
          }else{
            console.log("PARTITIA "+(parti-i+1)+" / "+parti+" E GATA")
            ls_rasps.push(e.data[1])
            if(ls_rasps.length === parti){
              for(let parte of ls_rasps){
                if(ls_rasps.length === parti){
                  ls_rasp = {...ls_rasp, ...parte}
                }
              }
              var sfarsit = new Date().getTime()
              console.log("Durata: "+((sfarsit-timpInceput)/1000)+" secunde")

              document.getElementById("status").innerText = "{{i|add:1}} / {{ cuv|length }}"
              document.getElementById("start").removeAttribute('disabled', '')

              init()
            }
          }
          
        })
        cuvLoad.postMessage([bucata, listaCuvinte])
    }
  </script>
</html>